<!DOCTYPE html><html lang="en" class="transform"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.svg">
    <!-- Preload front from google - it is faster than serving it from the Netlify CDN. -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta data changed on build -->
    <title>Processing Messages (Tasks) that are part of a Cluster</title>
    <script type="module" crossorigin="" src="/assets/app.3d6c68a9.js"></script>
    <link rel="modulepreload" href="/assets/vendor.09be1bf3.js">
    <style>*,:before,:after{-webkit-box-sizing:border-box;box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb;}*{--tw-ring-inset:var(--tw-empty, );--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59, 130, 246, .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;}:root{-moz-tab-size:4;-o-tab-size:4;tab-size:4;}a{color:inherit;text-decoration:inherit;}body{margin:0;font-family:inherit;line-height:inherit;}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0;text-transform:none;background-color:transparent;background-image:none;padding:0;line-height:inherit;color:inherit;}button{-webkit-appearance:button;}button{cursor:pointer;}html{-webkit-text-size-adjust:100%;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";line-height:1.5;}h1{font-size:inherit;font-weight:inherit;}pre{font-size:1em;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;}p,h1,pre{margin:0;}svg{display:block;vertical-align:middle;}.prose{color:#374151;max-width:65ch;font-size:1rem;line-height:1.75;}.prose a{color:#111827;text-decoration:underline;font-weight:500;}.prose ul>li{position:relative;padding-left:1.75em;}.prose ul>li:before{content:"";position:absolute;background-color:#d1d5db;border-radius:50%;width:.375em;height:.375em;top:0.6875em;left:.25em;}.prose h1{color:#111827;font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111;}.prose h2{color:#111827;font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333;}.prose code{color:#111827;font-weight:600;font-size:.875em;}.prose code:before{content:"`";}.prose code:after{content:"`";}.prose pre{color:#e5e7eb;background-color:#1f2937;overflow-x:auto;font-size:.875em;line-height:1.7142857;margin-top:1.7142857em;margin-bottom:1.7142857em;border-radius:.375rem;padding:.8571429em 1.1428571em;}.prose pre code{background-color:transparent;border-width:0;border-radius:0;padding:0;font-weight:400;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit;}.prose pre code:before{content:none;}.prose pre code:after{content:none;}.prose p{margin-top:1.25em;margin-bottom:1.25em;}.prose img{margin-top:2em;margin-bottom:2em;}.prose ul{margin-top:1.25em;margin-bottom:1.25em;list-style-type:none;}.prose li{margin-top:.5em;margin-bottom:.5em;}.prose h2+*{margin-top:0;}.prose>:first-child{margin-top:0;}.prose>:last-child{margin-bottom:0;}.prose-sm{font-size:.875rem;line-height:1.7142857;max-width:100%;color:inherit;}.prose-sm p{margin-top:1.1428571em;margin-bottom:1.1428571em;font-size:18px;}.prose-sm h1{font-size:2.1428571em;margin-top:0;margin-bottom:.8em;line-height:1.2;color:inherit;}.prose-sm h2{font-size:1.4285714em;margin-top:1.6em;margin-bottom:.8em;line-height:1.4;color:inherit;}.prose-sm img{margin-top:0;margin-bottom:0;}.prose-sm code{font-size:.8571429em;color:inherit;}.prose-sm pre{font-size:18px;line-height:1.6666667;margin-top:1.6666667em;margin-bottom:1.6666667em;border-radius:.25rem;padding:0;}.prose-sm ul{margin-top:1.1428571em;margin-bottom:1.1428571em;}.prose-sm li{margin-top:.2857143em;margin-bottom:.2857143em;}.prose-sm ul>li{padding-left:1.5714286em;}.prose-sm ul>li:before{height:.3571429em;width:.3571429em;top:0.67857em;left:.2142857em;}.prose-sm h2+*{margin-top:0;}.prose-sm>:first-child{margin-top:0;}.prose-sm>:last-child{margin-bottom:0;}.prose-sm a{color:inherit;font-weight:500;text-decoration:underline;}.prose-sm a:hover{color:inherit;}@font-face{font-family:Dank Mono;src:url(/assets/DankMono-Bold.d89b0eba.woff2) format("woff2");font-weight:700;font-style:normal;font-display:swap;}@font-face{font-family:Dank Mono;src:url(/assets/DankMono-Italic.1a9414bc.woff2) format("woff2");font-weight:400;font-style:italic;font-display:swap;}@font-face{font-family:Dank Mono;src:url(/assets/DankMono-Regular.2fe2c7c9.woff2) format("woff2");font-weight:400;font-style:normal;font-display:swap;}.heroicon:before{vertical-align:text-top;font-family:heroicons!important;font-style:normal;font-weight:400!important;vertical-align:top;}@font-face{font-family:heroicons;src:url(/assets/heroicons.1c0542d8.eot?#iefix) format("embedded-opentype"),url(/assets/heroicons.831c3bd7.woff) format("woff"),url(/assets/heroicons.1e50c56c.woff2) format("woff2"),url(/assets/heroicons.6ea4c5e7.ttf) format("truetype"),url(/assets/heroicons.11233d2d.svg#heroicons) format("svg");}.heroicon{line-height:1;}.heroicon-duplicate:before{content:"\f125";}:root{--nord0:#2e3440;--nord1:#3b4252;--nord2:#434c5e;--nord3:#4c566a;--nord4:#d8dee9;--nord5:#e5e9f0;--nord6:#eceff4;--nord7:#8fbcbb;--nord8:#88c0d0;--nord9:#81a1c1;--nord10:#5e81ac;--nord11:#bf616a;--nord12:#d08770;--nord13:#ebcb8b;--nord14:#a3be8c;--nord15:#b48ead;}html{--back:#22212C;--middle:#44475a;--front:#6272a4;--primary:#f8f8f2;--secondary:#ffb86c;--tertiary:#9580FF;--rose:#FF7AC6;--corn:#f1fa8c;--grass:#50fa7b;--muted:#6272a4;--highlight-primary:#ffb86c;--highlight-muted:#ffb86c;}pre,.prose code,.shiki{font-family:Dank Mono;font-size:18px;white-space:pre;-webkit-overflow-scrolling:touch;}.prose .markdown-it-code-copy>:first-child{font-size:1.25rem;line-height:1.75rem;opacity:.4;padding:.5rem;--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity));}.prose .markdown-it-code-copy>:first-child:hover{opacity:.8;}pre.twoslash:hover data-lsp{border-color:#6272a4;}.code-container .line{--tw-border-opacity:1;border-color:rgba(40,42,54,var(--tw-border-opacity));border-left-width:6px;padding-left:1rem;padding-right:1rem;}.code-container{display:inline-block;padding-top:2.5rem!important;padding-bottom:2.5rem!important;width:100%;-webkit-transition-property:background-color,border-color,color,fill,stroke;-o-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);-o-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1);-webkit-transition-duration:.15s;-o-transition-duration:.15s;transition-duration:.15s;-webkit-transition-duration:.5s;-o-transition-duration:.5s;transition-duration:.5s;}.code-container::-webkit-scrollbar{display:none;}.language-id{display:none;}data-lsp{border-bottom:1px solid transparent;transition-timing-function:ease;transition:border-color .3s;}@media (prefers-reduced-motion: reduce){data-lsp{transition:none;}}.twemoji{display:inline-block;height:1em;width:1em;margin:0 .05em 0 .1em;}.native-emoji{display:none;}a:active{outline:2px solid transparent;outline-offset:2px;}a.header-anchor{float:left;margin-top:.125em;margin-left:-1.2em;padding-right:.5em;font-size:.85em;opacity:0;text-decoration:none;border:0!important;}a.header-anchor:hover,a.header-anchor:focus{text-decoration:none;}h2:hover .header-anchor,h2:focus .header-anchor{opacity:.5;}.prose a:hover{color:var(--secondary);}.prose a{-webkit-transition-property:background-color,border-color,color,fill,stroke;-o-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);-o-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1);-webkit-transition-duration:.15s;-o-transition-duration:.15s;transition-duration:.15s;-webkit-transition-duration:.3s;-o-transition-duration:.3s;transition-duration:.3s;}.prose ul{font-size:18px;}.prose h1:focus,.prose h2:focus{outline:2px solid transparent;outline-offset:2px;}.prose .alert{border-left-width:4px;padding:1rem;}.prose .alert.alert-dracula{--tw-bg-opacity:1;background-color:rgba(149,128,255,var(--tw-bg-opacity));--tw-bg-opacity:.25;--tw-border-opacity:1;border-color:rgba(149,128,255,var(--tw-border-opacity));}.prose img{max-width:100%;-o-object-fit:cover;object-fit:cover;}html,body,#app{margin:0;padding:0;font-family:Inter;}.space-x-6>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1.5rem * var(--tw-space-x-reverse));margin-left:calc(1.5rem * calc(1 - var(--tw-space-x-reverse)));}.bg-back{background-color:var(--back);}.hover\:bg-muted:hover{background-color:var(--muted);}.border-blade{--tw-border-opacity:1;border-color:rgba(80,250,123,var(--tw-border-opacity));}.border-muted{border-color:var(--muted);}.border-l-4{border-left-width:4px;}.border-b{border-bottom-width:1px;}.border-r{border-right-width:1px;}.cursor-pointer{cursor:pointer;}.flex{display:-webkit-box;display:-ms-flexbox;display:-webkit-flex;display:flex;}.grid{display:-ms-grid;display:grid;}.flex-col{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;-webkit-flex-direction:column;flex-direction:column;}.items-center{-webkit-box-align:center;-ms-flex-align:center;-webkit-align-items:center;align-items:center;}.justify-center{-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.justify-between{-webkit-box-pack:justify;-ms-flex-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;}.flex-grow{-webkit-box-flex:1;-ms-flex-positive:1;-webkit-flex-grow:1;flex-grow:1;}.flex-shrink-0{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-shrink:0;}.font-bold{font-weight:700;}.font-semibold{font-weight:600;}.h-6{height:1.5rem;}.h-0{height:0px;}.h-full{height:100%;}.h-screen{height:100vh;}.text-sm{font-size:.875rem;line-height:1.25rem;}.text-lg{font-size:1.125rem;line-height:1.75rem;}.\!text-base{font-size:1rem!important;line-height:1.5rem!important;}.\!text-3xl{font-size:1.875rem!important;line-height:2.25rem!important;}.m-auto{margin:auto;}.mx-auto{margin-left:auto;margin-right:auto;}.mb-8{margin-bottom:2rem;}.\!mb-3{margin-bottom:.75rem!important;}.max-w-3xl{max-width:48rem;}.overflow-hidden{overflow:hidden;}.overflow-scroll{overflow:scroll;}.p-4{padding:1rem;}.py-4{padding-top:1rem;padding-bottom:1rem;}.px-4{padding-left:1rem;padding-right:1rem;}.py-6{padding-top:1.5rem;padding-bottom:1.5rem;}.pl-8{padding-left:2rem;}.relative{position:relative;}[fill~=none]{fill:none;}.text-left{text-align:left;}.text-primary{color:var(--primary);}.hover\:text-blade:hover{--tw-text-opacity:1;color:rgba(80,250,123,var(--tw-text-opacity));}.text-nosferatu{--tw-text-opacity:1;color:rgba(34,33,44,var(--tw-text-opacity));}.hover\:text-secondary:hover{color:var(--secondary);}.\!text-primary{color:var(--primary)!important;}.w-6{width:1.5rem;}.w-full{width:100%;}.z-50{z-index:50;}.grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr));}.col-span-3{-ms-grid-column-span:span 3 / span 3;grid-column:span 3 / span 3;}.col-span-9{-ms-grid-column-span:span 9 / span 9;grid-column:span 9 / span 9;}.transform{--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0;--tw-rotate:0;--tw-rotate-x:0;--tw-rotate-y:0;--tw-rotate-z:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-scale-z:1;-webkit-transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) translateZ(var(--tw-translate-z)) rotate(var(--tw-rotate)) rotateX(var(--tw-rotate-x)) rotateY(var(--tw-rotate-y)) rotateZ(var(--tw-rotate-z)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)) scaleZ(var(--tw-scale-z));-ms-transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) translateZ(var(--tw-translate-z)) rotate(var(--tw-rotate)) rotateX(var(--tw-rotate-x)) rotateY(var(--tw-rotate-y)) rotateZ(var(--tw-rotate-z)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)) scaleZ(var(--tw-scale-z));transform:translate(var(--tw-translate-x)) translateY(var(--tw-translate-y)) translateZ(var(--tw-translate-z)) rotate(var(--tw-rotate)) rotateX(var(--tw-rotate-x)) rotateY(var(--tw-rotate-y)) rotate(var(--tw-rotate-z)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)) scaleZ(var(--tw-scale-z));}.-rotate-90{--tw-rotate:-90deg;}.transition-colors{-webkit-transition-property:background-color,border-color,color,fill,stroke;-o-transition-property:background-color,border-color,color,fill,stroke;transition-property:background-color,border-color,color,fill,stroke;-webkit-transition-timing-function:cubic-bezier(.4,0,.2,1);-o-transition-timing-function:cubic-bezier(.4,0,.2,1);transition-timing-function:cubic-bezier(.4,0,.2,1);-webkit-transition-duration:.15s;-o-transition-duration:.15s;transition-duration:.15s;}.duration-150{-webkit-transition-duration:.15s;-o-transition-duration:.15s;transition-duration:.15s;}@media (min-width: 1024px){.lg\:text-xl{font-size:1.25rem;line-height:1.75rem;}}</style><link rel="preload" href="/assets/app.918e7b3f.css" as="style">
  <link rel="modulepreload" crossorigin="" href="/assets/processing-tasks-of-a-cluster.cd81c032.js"><link rel="modulepreload" crossorigin="" href="/assets/Post.3c6da465.js"><meta name="description" content="Nick Graffis's Personal Website"><meta property="og:title" content="Processing Messages (Tasks) that are part of a Cluster"><meta name="head:count" content="2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/DankMono-Bold.d89b0eba.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/DankMono-Italic.1a9414bc.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/DankMono-Regular.2fe2c7c9.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/heroicons.1c0542d8.eot?#iefix"></head>
  <body class="text-primary bg-back">
    <div id="app" data-server-rendered="true"><div class="h-screen flex flex-col"><nav class="px-4 m-auto py-6 text-sm z-50 flex items-center justify-between w-full font-semibold text-nosferatu dark:text-cullen border-b border-muted"><a href="/" class="flex items-center justify-center h-full flex-shrink-0"><div class="relative"><svg class="" viewBox="0 0 99 66"><defs><linearGradient id="a" x1=".5" y1="33" x2="65.75" y2="33" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#3b3b3d"></stop><stop offset="1" stop-color="#cfd0d2"></stop></linearGradient><linearGradient id="b" x1="33.25" y1="33" x2="98.5" y2="33" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#396eb5"></stop><stop offset="1" stop-color="#20386c"></stop></linearGradient></defs><path d="M65.75 36A32.76 32.76 0 0 1 .5 36h7.77a25.24 25.24 0 0 0 24.86 22.51A25.26 25.26 0 0 0 58 36zM58 30A25.26 25.26 0 0 0 33.13 7.49 25.24 25.24 0 0 0 8.27 30H.5a32.76 32.76 0 0 1 65.25 0z" style="fill:url(#a);"></path><path d="M41 36a25 25 0 0 0 49.72 0h7.78a32.76 32.76 0 0 1-65.25 0zm-7.76-6a32.76 32.76 0 0 1 65.26 0h-7.77A25 25 0 0 0 41 30z" style="fill:url(#b);"></path></svg></div></a><div class="flex space-x-6 items-center text-lg"><a href="/posts" class="cursor-pointer lg:text-xl !text-base hover:text-secondary transition-colors duration-150"><p>AWS Documentation</p></a><a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SQS.html" class="cursor-pointer lg:text-xl !text-base hover:text-secondary transition-colors duration-150"><p>AWS Documentation</p></a><a class="cursor-pointer lg:text-xl !text-base hover:text-secondary transition-colors duration-150"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 48 48"><g fill="none"><path d="M24 37c7.18 0 13-5.82 13-13s-5.82-13-13-13s-13 5.82-13 13s5.82 13 13 13z" stroke="currentColor" stroke-width="4" stroke-linejoin="round"></path><path d="M24 6a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M38.5 12a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M44.5 26.5a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M38.5 41a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M24 47a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M9.5 41a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M3.5 26.5a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path><path d="M9.5 12a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5z" fill="currentColor"></path></g></svg></a></div></nav><div class="grid grid-cols-12 overflow-hidden flex-grow"><div class="col-span-3 overflow-scroll border-r border-muted"><div><!--[--><div class="w-full"><div><!--[--><div class="font-bold p-4 hover:bg-muted flex justify-between"><p>Setup</p><svg xmlns="http://www.w3.org/2000/svg" class="-rotate-90 h-6 w-6 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="h-0 overflow-hidden"><!--[--><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Give Initial Lambdas Permission</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Create A Queue</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Create A Lambda</div></div><!--]--></div><!--]--></div></div><div class="w-full"><div><!--[--><div class="font-bold p-4 hover:bg-muted flex justify-between"><p>Sending A Message</p><svg xmlns="http://www.w3.org/2000/svg" class="-rotate-90 h-6 w-6 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="h-0 overflow-hidden"><!--[--><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">The Sqs Sdk</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Our Dynamo Record</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Getting Started</div></div><!--]--></div><!--]--></div></div><div class="w-full"><div><!--[--><div class="font-bold p-4 hover:bg-muted flex justify-between"><p>Queuesystem</p><svg xmlns="http://www.w3.org/2000/svg" class="-rotate-90 h-6 w-6 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="h-0 overflow-hidden"><!--[--><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Readme</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Instruct</div></div><!--]--></div><!--]--></div></div><div class="w-full"><div><!--[--><div class="font-bold p-4 hover:bg-muted flex justify-between"><p>Processing Messages</p><svg xmlns="http://www.w3.org/2000/svg" class="-rotate-90 h-6 w-6 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="h-0 overflow-hidden"><!--[--><div class="w-full hover:text-blade"><div class="border-l-4 pl-8 py-4 border-blade">Processing Tasks Of A Cluster</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Getting Started</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Advanced Features</div></div><!--]--></div><!--]--></div></div><div class="w-full"><div><!--[--><div class="font-bold p-4 hover:bg-muted flex justify-between"><p>Message Clusters</p><svg xmlns="http://www.w3.org/2000/svg" class="-rotate-90 h-6 w-6 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="h-0 overflow-hidden"><!--[--><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Overview</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Our Global S3 Storage</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Our Dynamo Records</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Createing A Cluster</div></div><div class="w-full hover:text-blade"><div class="pl-8 py-4 border-blade">Behind The Hood</div></div><!--]--></div><!--]--></div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">What Is Sqs</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Send Many Messages</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Send A Message</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Process A Task</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Process A Message</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted"></div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Create A Queue</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Create A Message Cluster</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">Create A Lambda</div></div><div class="w-full"><div class="p-4 border-blade hover:bg-muted">:All(.*)*</div></div><!--]--></div></div><div class="col-span-9 overflow-scroll h-full"><div class="prose prose-sm p-4 text-left mb-8 max-w-3xl mx-auto"><!-- TODO: Why sm? --><!-- Only show if there is a title or display included in the frontmatter --><h1 class="!mb-3 !text-3xl lg:!text-6xl !text-primary"><span>Processing Messages (Tasks) that are part of a Cluster</span></h1><!-- Only show if there is a date && duration inside the frontmatter --><!----><!--[--><div class="prose prose-sm text-left max-w-3xl mx-auto"><ul><li></li></ul><h2 id="reading-the-sqs-record-for-a-message%2C-message-record%2C-and-message-cluster" tabindex="-1"><a class="header-anchor" href="#reading-the-sqs-record-for-a-message%2C-message-record%2C-and-message-cluster" aria-hidden="true">#</a><span class="emoji-wrapper"><span class="native-emoji"></span></span><span class="emoji-wrapper"><span class="native-emoji">Reading the SQS Record for a Message, Message Record, and Message Cluster</span> Reading the SQS Record for a Message, Message Record, and Message Cluster </span></h2><p><span class="emoji-wrapper"><span class="native-emoji">You can start processing messages that are part of a cluster the same way that you would process a message that is not part of a cluster. You can use the </span> You can start processing messages that are part of a cluster the same way that you would process a message that is not part of a cluster. You can use the </span><code>readSQSRecord</code><span class="emoji-wrapper"><span class="native-emoji"> to get access to the message data and an additional </span> to get access to the message data and an additional </span><code>getMessageCluster</code><span class="emoji-wrapper"><span class="native-emoji"> method to get access to the cluster data.</span> method to get access to the cluster data. </span></p><div style="position:relative;"><pre class="shiki dracula twoslash lsp" style="background-color:#282A36;color:#F8F8F2;"><div class="language-id">ts</div><code class="code-container"><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) data: string</span></code></div></pre>">data</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span><span style="color:#F8F8F2;">,</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) moreData: number</span></code></div></pre>">moreData</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">number</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) stuff: string</span></code></div></pre>">stuff</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">async</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>processMessage</span><span style=&quot;color: #F8F8F2&quot;>(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>void</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">processMessage</data-lsp></span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(alias) </span><span style=&quot;color: #FF79C6&quot;>interface</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span>
<span style=&quot;color: #8BE9FD; font-style: italic&quot;>import</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span></code></div></pre>">SQSRecord</data-lsp></span><span style="color:#F8F8F2;">) {</span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> id</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">id</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> body</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span></code></div></pre>">body</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> ((</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;) </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">getMessageCluster</data-lsp> } </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>readSQSRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Response</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">readSQSRecord</data-lsp></span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;">&gt;(<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp>)</span></div><div class="line"><span style="color:#F8F8F2;">  </span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>} </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">messageCluster</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> ((</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;) </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">getMessageCluster</data-lsp> </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;</span></code></div></pre>">getMessageCluster</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div></code></pre><button class="markdown-it-code-copy" data-clipboard-text="
	import { SQSRecord } from <SINGLE-QUOTE>aws-lambda<SINGLE-QUOTE>
import AWS from <SINGLE-QUOTE>aws-sdk<SINGLE-QUOTE>

export type SQSMessageKey = `SQSMessage${string}`

declare class Stringified<T> extends String {
  private ___stringified: T
}

interface JSON {
  stringify<T>(
    value: T,
    replacer?: (key: string, value: any) => any,
    space?: string | number
  ): string &amp; Stringified<T>
  parse<T>(text: Stringified<T>, reviver?: (key: any, value: any) => any): T
  parse(text: string, reviver?: (key: any, value: any) => any): any
}

export type MessageClusterRecord<Meta = any, TaskMeta = any> = {
  type: RecordType
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  status: Status
  error?: any[]
  statusCode: StatusCode
  startedAt: string
  completedAt: string | null
  completedTasks: Task<TaskMeta>[]
  incompleteTasks: Task<TaskMeta>[]
  bucketParams: {
    Bucket: string
    Key: string
  }
  meta?: Meta
  updatedAt: string
  expiresAt: string
}

export type MessageRecord<Meta = any, Body = any> = {
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  id: string
  url: string
  meta?: Meta
  body: String &amp; Stringified<Body>
  type: RecordType
  startedAt: string
  status: Status
  statusCode: StatusCode
  completedAt: string | null
  updatedAt: string
  expiresAt: string
  consumtion_count: number
  error?: any[]
}

export type Task<Meta = any> = {
  meta: Meta
  type: <SINGLE-QUOTE>task<SINGLE-QUOTE>
  id?: string
  status?: Status
}

export enum RecordType {
  cluster = <SINGLE-QUOTE>cluster<SINGLE-QUOTE>,
  task = <SINGLE-QUOTE>task<SINGLE-QUOTE>,
  message = <SINGLE-QUOTE>message<SINGLE-QUOTE>
}

export enum Status {
  preFlight = <SINGLE-QUOTE>PRE FLIGHT<SINGLE-QUOTE>,
  inProgress = <SINGLE-QUOTE>IN PROGRESS<SINGLE-QUOTE>,
  complete = <SINGLE-QUOTE>COMPLETE<SINGLE-QUOTE>,
  error = <SINGLE-QUOTE>ERROR<SINGLE-QUOTE>
}

export enum StatusCode {
  preFlight = 0,
  inProgress = 100,
  complete = 200,
  error = 400,
  stopped = 500
}

type Response<Meta = any, Globals = any, Body = any> = {
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  task?: string
  id?: string
  body: Body
  type: RecordType,
  getMessageCluster?: 
    (consistentRead?: boolean) => Promise<{ 
      record: MessageClusterRecord<Meta>,
      getGlobals: () => Promise<Globals> 
    }>,
  getMessageRecord: (consistentRead?: boolean) => Promise<MessageRecord<Meta>>
}

/**
 * Parse the SQS record to gain access to helpful meta data and getters
 * @param event - The SQS record to parse
 * @returns The basic meta data for the message and getters for globals and record
 */
function readSQSRecord<Body = any, Meta = any, Globals = any>(record: SQSRecord): Response<Meta, Globals, Body> {
  const body: any = JSON.parse(record.body)
  const url = <SINGLE-QUOTE>jfkdla;f<SINGLE-QUOTE>
  const pKey = `SQSMesssage${<SINGLE-QUOTE>fdfdafda<SINGLE-QUOTE>}` as SQSMessageKey
  const id = <SINGLE-QUOTE>jfkdlafjkdal;<SINGLE-QUOTE>
  const rKey = `SQSMesssage${<SINGLE-QUOTE>jfkdla;fjkda<SINGLE-QUOTE>}` as SQSMessageKey
  const task = undefined
  const type = RecordType.message || RecordType.cluster
  return {
    url,
    pKey,
    rKey,
    task,
    body,
    type,
    id: record.messageId,
    getMessageRecord: (consistentRead = false) =>
      (async <Meta>() => ({
        pKey,
        rKey,
        id,
        url,
        meta: body.meta,
        body: body.body,
        type,
        startedAt: body.startedAt,
        status: body.status,
        statusCode: body.statusCode,
        completedAt: body.completedAt,
        updatedAt: body.updatedAt,
        expiresAt: body.expiresAt,
        consumtion_count: body.consumtion_count,
        error: body.error
      }))(),
  }
}

// ---cut---

type Body = {
  data: string,
  moreData: number
}

type MetaData = {
  stuff: string
}

async function processMessage(record: SQSRecord) {
  const { id, body, getMessageRecord, getMessageCluster } = 
    readSQSRecord<Body, MetaData>(record)
  
  const messageRecord = await getMessageRecord()

  const messageCluster = 
    getMessageCluster &amp;&amp; 
    await getMessageCluster()
}

" style="position:absolute;top:7.5px;right:6px;cursor:pointer;outline:none;" title="Copy"><span style="" class="heroicon heroicon-duplicate"></span></button></div><h2 id="getting-the-globals-for-a-message-cluster" tabindex="-1"><a class="header-anchor" href="#getting-the-globals-for-a-message-cluster" aria-hidden="true">#</a><span class="emoji-wrapper"><span class="native-emoji"></span></span><span class="emoji-wrapper"><span class="native-emoji">Getting the Globals for a Message Cluster</span> Getting the Globals for a Message Cluster </span></h2><p><span class="emoji-wrapper"><span class="native-emoji">When you call </span> When you call </span><code>getMessageCluster()</code><span class="emoji-wrapper"><span class="native-emoji"> you are returned a method to get the globals for the cluster.</span> you are returned a method to get the globals for the cluster. </span></p><div style="position:relative;"><pre class="shiki dracula twoslash lsp" style="background-color:#282A36;color:#F8F8F2;"><div class="language-id">ts</div><code class="code-container"><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) data: string</span></code></div></pre>">data</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span><span style="color:#F8F8F2;">,</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) moreData: number</span></code></div></pre>">moreData</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">number</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) stuff: string</span></code></div></pre>">stuff</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) firstName: string</span></code></div></pre>">firstName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span><span style="color:#F8F8F2;">,</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) lastName: string</span></code></div></pre>">lastName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span></div><div class="line"><span style="color:#F8F8F2;">}[]</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">async</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>processMessage</span><span style=&quot;color: #F8F8F2&quot;>(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>void</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">processMessage</data-lsp></span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(alias) </span><span style=&quot;color: #FF79C6&quot;>interface</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span>
<span style=&quot;color: #8BE9FD; font-style: italic&quot;>import</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span></code></div></pre>">SQSRecord</data-lsp></span><span style="color:#F8F8F2;">) {</span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> id</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">id</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> body</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span></code></div></pre>">body</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> ((</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;) </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">getMessageCluster</data-lsp> } </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>readSQSRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Response</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">readSQSRecord</data-lsp></span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;">&gt;(<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp>)</span></div><div class="line"><span style="color:#F8F8F2;">  </span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>} </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">messageCluster</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> ((</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;) </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">getMessageCluster</data-lsp> </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;</span></code></div></pre>">getMessageCluster</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">if</span><span style="color:#F8F8F2;"> (<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>} </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">messageCluster</data-lsp>) {</span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> globals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span></code></div></pre>">globals</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">messageCluster</data-lsp>.</span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) getGlobals: () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #FF79C6&quot;>&amp;lt;</span><span style=&quot;color: #F8F8F2&quot;>Globals</span><span style=&quot;color: #FF79C6&quot;>&amp;gt;</span></code></div></pre>">getGlobals</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line"><span style="color:#F8F8F2;">  }</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div></code></pre><button class="markdown-it-code-copy" data-clipboard-text="
	import { SQSRecord } from <SINGLE-QUOTE>aws-lambda<SINGLE-QUOTE>
import AWS from <SINGLE-QUOTE>aws-sdk<SINGLE-QUOTE>

export type SQSMessageKey = `SQSMessage${string}`

declare class Stringified<T> extends String {
  private ___stringified: T
}

interface JSON {
  stringify<T>(
    value: T,
    replacer?: (key: string, value: any) => any,
    space?: string | number
  ): string &amp; Stringified<T>
  parse<T>(text: Stringified<T>, reviver?: (key: any, value: any) => any): T
  parse(text: string, reviver?: (key: any, value: any) => any): any
}

export type MessageClusterRecord<Meta = any, TaskMeta = any> = {
  type: RecordType
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  status: Status
  error?: any[]
  statusCode: StatusCode
  startedAt: string
  completedAt: string | null
  completedTasks: Task<TaskMeta>[]
  incompleteTasks: Task<TaskMeta>[]
  bucketParams: {
    Bucket: string
    Key: string
  }
  meta?: Meta
  updatedAt: string
  expiresAt: string
}

export type MessageRecord<Meta = any, Body = any> = {
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  id: string
  url: string
  meta?: Meta
  body: String &amp; Stringified<Body>
  type: RecordType
  startedAt: string
  status: Status
  statusCode: StatusCode
  completedAt: string | null
  updatedAt: string
  expiresAt: string
  consumtion_count: number
  error?: any[]
}

export type Task<Meta = any> = {
  meta: Meta
  type: <SINGLE-QUOTE>task<SINGLE-QUOTE>
  id?: string
  status?: Status
}

export enum RecordType {
  cluster = <SINGLE-QUOTE>cluster<SINGLE-QUOTE>,
  task = <SINGLE-QUOTE>task<SINGLE-QUOTE>,
  message = <SINGLE-QUOTE>message<SINGLE-QUOTE>
}

export enum Status {
  preFlight = <SINGLE-QUOTE>PRE FLIGHT<SINGLE-QUOTE>,
  inProgress = <SINGLE-QUOTE>IN PROGRESS<SINGLE-QUOTE>,
  complete = <SINGLE-QUOTE>COMPLETE<SINGLE-QUOTE>,
  error = <SINGLE-QUOTE>ERROR<SINGLE-QUOTE>
}

export enum StatusCode {
  preFlight = 0,
  inProgress = 100,
  complete = 200,
  error = 400,
  stopped = 500
}

type Response<Meta = any, Globals = any, Body = any> = {
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  task?: string
  id?: string
  body: Body
  type: RecordType,
  getMessageCluster?: 
    (consistentRead?: boolean) => Promise<{ 
      record: MessageClusterRecord<Meta>,
      getGlobals: () => Promise<Globals> 
    }>,
  getMessageRecord: (consistentRead?: boolean) => Promise<MessageRecord<Meta>>
}

/**
 * Parse the SQS record to gain access to helpful meta data and getters
 * @param event - The SQS record to parse
 * @returns The basic meta data for the message and getters for globals and record
 */
function readSQSRecord<Body = any, Meta = any, Globals = any>(record: SQSRecord): Response<Meta, Globals, Body> {
  const body: any = JSON.parse(record.body)
  const url = <SINGLE-QUOTE>jfkdla;f<SINGLE-QUOTE>
  const pKey = `SQSMesssage${<SINGLE-QUOTE>fdfdafda<SINGLE-QUOTE>}` as SQSMessageKey
  const id = <SINGLE-QUOTE>jfkdlafjkdal;<SINGLE-QUOTE>
  const rKey = `SQSMesssage${<SINGLE-QUOTE>jfkdla;fjkda<SINGLE-QUOTE>}` as SQSMessageKey
  const task = undefined
  const type = RecordType.message || RecordType.cluster
  return {
    url,
    pKey,
    rKey,
    task,
    body,
    type,
    id: record.messageId,
    getMessageRecord: (consistentRead = false) =>
      (async <Meta>() => ({
        pKey,
        rKey,
        id,
        url,
        meta: body.meta,
        body: body.body,
        type,
        startedAt: body.startedAt,
        status: body.status,
        statusCode: body.statusCode,
        completedAt: body.completedAt,
        updatedAt: body.updatedAt,
        expiresAt: body.expiresAt,
        consumtion_count: body.consumtion_count,
        error: body.error
      }))(),
  }
}

// ---cut---

type Body = {
  data: string,
  moreData: number
}

type MetaData = {
  stuff: string
}

type Globals = {
  firstName: string,
  lastName: string
}[]

async function processMessage(record: SQSRecord) {
  const { id, body, getMessageRecord, getMessageCluster } = 
    readSQSRecord<Body, MetaData, Globals>(record)
  
  const messageRecord = await getMessageRecord()

  const messageCluster = 
    getMessageCluster &amp;&amp; 
    await getMessageCluster()

  if (messageCluster) {
    const globals = await messageCluster.getGlobals()
  }
}

" style="position:absolute;top:7.5px;right:6px;cursor:pointer;outline:none;" title="Copy"><span style="" class="heroicon heroicon-duplicate"></span></button></div><p><span class="emoji-wrapper"><span class="native-emoji">This is done so that you do not waste time fetching data from S3 if it is not needed.</span> This is done so that you do not waste time fetching data from S3 if it is not needed. </span></p><div class="alert alert-dracula" role="alert"><p><span class="emoji-wrapper"><span class="native-emoji">🧛🏻‍♂️ Hey, a possible improvement here would be to store the s3 bucket params in the message body as well. This means that you could get global data without getting the message cluster record.</span><img class="twemoji" draggable="false" alt="🧛🏻‍♂️" src="https://twemoji.maxcdn.com/v/13.1.0/72x72/1f9db-1f3fb-200d-2642-fe0f.png"> Hey, a possible improvement here would be to store the s3 bucket params in the message body as well. This means that you could get global data without getting the message cluster record. </span></p></div><h2 id="updating-global-data" tabindex="-1"><a class="header-anchor" href="#updating-global-data" aria-hidden="true">#</a><span class="emoji-wrapper"><span class="native-emoji"></span></span><span class="emoji-wrapper"><span class="native-emoji">Updating Global Data</span> Updating Global Data </span></h2><p><span class="emoji-wrapper"><span class="native-emoji">You can use </span> You can use </span><code>updateClusterGlobals()</code><span class="emoji-wrapper"><span class="native-emoji"> to update the globals for a cluster. You can pass it the key as either the </span> to update the globals for a cluster. You can pass it the key as either the </span><code>pKey</code><span class="emoji-wrapper"><span class="native-emoji"> and </span> and </span><code>rKey</code><span class="emoji-wrapper"><span class="native-emoji"> object, or simply just the </span> object, or simply just the </span><code>pKey</code><span class="emoji-wrapper"><span class="native-emoji"> as the global data store only uses the </span> as the global data store only uses the </span><code>pKey</code><span class="emoji-wrapper"><span class="native-emoji">.</span> . </span></p><p><span class="emoji-wrapper"><span class="native-emoji">You can also pass it a new globals object, or pass it a function that returns a new globals object and accepts the old globals object.</span> You can also pass it a new globals object, or pass it a function that returns a new globals object and accepts the old globals object. </span></p><div style="position:relative;"><pre class="shiki dracula twoslash lsp" style="background-color:#282A36;color:#F8F8F2;"><div class="language-id">ts</div><code class="code-container"><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) data: string</span></code></div></pre>">data</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span><span style="color:#F8F8F2;">,</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) moreData: number</span></code></div></pre>">moreData</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">number</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) stuff: string</span></code></div></pre>">stuff</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">type</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) firstName: string</span></code></div></pre>">firstName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span><span style="color:#F8F8F2;">,</span></div><div class="line"><span style="color:#F8F8F2;">  <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) lastName: string</span></code></div></pre>">lastName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;">string</span></div><div class="line"><span style="color:#F8F8F2;">}[]</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#FF79C6;">async</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>processMessage</span><span style=&quot;color: #F8F8F2&quot;>(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>void</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">processMessage</data-lsp></span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(alias) </span><span style=&quot;color: #FF79C6&quot;>interface</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span>
<span style=&quot;color: #8BE9FD; font-style: italic&quot;>import</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span></code></div></pre>">SQSRecord</data-lsp></span><span style="color:#F8F8F2;">) {</span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> id</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">id</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> body</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span></code></div></pre>">body</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp>, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> getMessageCluster</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> ((</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;{</span>
<span style=&quot;color: #F8F8F2&quot;>    record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageClusterRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>    </span><span style=&quot;color: #50FA7B&quot;>getGlobals</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> () </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;;</span>
<span style=&quot;color: #F8F8F2&quot;>}&amp;gt;) </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span></code></div></pre>">getMessageCluster</data-lsp> } </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span></div><div class="line"><span style="color:#F8F8F2;">    </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>readSQSRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>record</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>SQSRecord</span><span style=&quot;color: #F8F8F2&quot;>)</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Response</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">readSQSRecord</data-lsp></span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Body</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    data</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    moreData</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>number</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">Body</data-lsp></span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    stuff</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}</span></code></div></pre>">MetaData</data-lsp></span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;">&gt;(<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) record: SQSRecord</span></code></div></pre>">record</data-lsp>)</span></div><div class="line"><span style="color:#F8F8F2;">  </span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>getMessageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> (</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>consistentRead</span><span style=&quot;color: #FF79C6&quot;>?:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>boolean</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>|</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>undefined</span><span style=&quot;color: #F8F8F2&quot;>) </span><span style=&quot;color: #FF79C6&quot;>=&amp;gt;</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Promise</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;&amp;gt;</span></code></div></pre>">getMessageRecord</data-lsp></span><span style="color:#F8F8F2;">()</span></div><div class="line">&nbsp;</div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;">// Perform a total rewrite of the global store</span></div><div class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>updateClusterGlobals</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>key</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    pKey</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></div>lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    rKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`SQSMessage<div id="app"></div>lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;}, &lt;/span&gt;&lt;span style="color: #FFB86C; font-style: italic"&gt;globals&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #FF79C6"&gt;|&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; ((&lt;/span&gt;&lt;span style="color: #FFB86C; font-style: italic"&gt;globals&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;) &lt;/span&gt;&lt;span style="color: #FF79C6"&gt;=&amp;gt;&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;))&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Promise&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;&amp;lt;{&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    pKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    rKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;}&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;updateClusterGlobals<span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;">&gt;(</span></code></pre></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">    { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) pKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;pKey<span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp>.<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) pKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;pKey, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) rKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;rKey<span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp>.<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) rKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;rKey },</code></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">    [{ <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) firstName: string</span></code></div></pre>">firstName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">'</span><span style="color:#F1FA8C;">John</span><span style="color:#E9F284;">'</span><span style="color:#F8F8F2;">, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) lastName: string</span></code></div></pre>">lastName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">'</span><span style="color:#F1FA8C;">Doe</span><span style="color:#E9F284;">'</span><span style="color:#F8F8F2;"> }]</span></code></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">  )</span></code></div><div class="line"><code class="code-container">&nbsp;</code></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;">// Perform a insert of data to the global store</span></code></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#50FA7B;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>function</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #50FA7B&quot;>updateClusterGlobals</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;(</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>key</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    pKey</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    rKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`SQSMessage<div id="app"></div>lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;}, &lt;/span&gt;&lt;span style="color: #FFB86C; font-style: italic"&gt;globals&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #FF79C6"&gt;|&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; ((&lt;/span&gt;&lt;span style="color: #FFB86C; font-style: italic"&gt;globals&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;) &lt;/span&gt;&lt;span style="color: #FF79C6"&gt;=&amp;gt;&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Globals&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;))&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;Promise&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;&amp;lt;{&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    pKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;    rKey&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;:&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt; &lt;/span&gt;&lt;span style="color: #8BE9FD; font-style: italic"&gt;string&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;;&lt;/span&gt;
&lt;span style="color: #F8F8F2"&gt;}&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;updateClusterGlobals<span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;">&gt;(</span></code></div><div class="line"><code class="code-container"><span style="color:#F8F8F2;">    { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) pKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;pKey<span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp>.<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) pKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"=""></data-lsp></span></code></div><code class="code-container">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;pKey, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) rKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"="">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;rKey</data-lsp><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>const</span><span style=&quot;color: #F8F8F2&quot;> messageRecord</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>MessageRecord</span><span style=&quot;color: #F8F8F2&quot;>&amp;lt;</span><span style=&quot;color: #FFB86C; font-style: italic&quot;>MetaData</span><span style=&quot;color: #F8F8F2&quot;>, </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>any</span><span style=&quot;color: #F8F8F2&quot;>&amp;gt;</span></code></div></pre>">messageRecord</data-lsp>.<data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) rKey: </span><span style=&quot;color: #F1FA8C&quot;>`SQSMessage<div id=" app"="">lt;/span&gt;&lt;span style="color: #FF79C6"&gt;${&lt;/span&gt;&lt;span style="color: #F8F8F2"&gt;string&lt;/span&gt;&lt;span style="color: #FF79C6"&gt;}&lt;/span&gt;&lt;span style="color: #F1FA8C"&gt;`&lt;/span&gt;&lt;/code&gt;&lt;/div&gt;&lt;/pre&gt;"&gt;rKey</data-lsp> },</span><div class="line"><span style="color:#F8F8F2;">    (</span><span style="color:#FFB86C;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) globals: Globals</span></code></div></pre>">globals</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;font-style:italic;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #FF79C6&quot;>type</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>Globals</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #FF79C6&quot;>=</span><span style=&quot;color: #F8F8F2&quot;> {</span>
<span style=&quot;color: #F8F8F2&quot;>    firstName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>    lastName</span><span style=&quot;color: #FF79C6&quot;>:</span><span style=&quot;color: #F8F8F2&quot;> </span><span style=&quot;color: #8BE9FD; font-style: italic&quot;>string</span><span style=&quot;color: #F8F8F2&quot;>;</span>
<span style=&quot;color: #F8F8F2&quot;>}[]</span></code></div></pre>">Globals</data-lsp></span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#F8F8F2;"> [</span><span style="color:#FF79C6;">...</span><span style="color:#F8F8F2;"><data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(parameter) globals: Globals</span></code></div></pre>">globals</data-lsp>, { <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) firstName: string</span></code></div></pre>">firstName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">'</span><span style="color:#F1FA8C;">John</span><span style="color:#E9F284;">'</span><span style="color:#F8F8F2;">, <data-lsp lsp="<pre class=&quot;shiki&quot;><div class=&quot;language-id&quot;>ts</div><div class='code-container'><code><span style=&quot;color: #F8F8F2&quot;>(property) lastName: string</span></code></div></pre>">lastName</data-lsp></span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">'</span><span style="color:#F1FA8C;">Doe</span><span style="color:#E9F284;">'</span><span style="color:#F8F8F2;"> }]</span></div><div class="line"><span style="color:#F8F8F2;">  )</span></div><div class="line"><span style="color:#F8F8F2;">}</span></div></code><button class="markdown-it-code-copy" data-clipboard-text="
	import { SQSRecord } from <SINGLE-QUOTE>aws-lambda<SINGLE-QUOTE>
import AWS from <SINGLE-QUOTE>aws-sdk<SINGLE-QUOTE>

export type SQSMessageKey = `SQSMessage${string}`

declare class Stringified<T> extends String {
  private ___stringified: T
}

interface JSON {
  stringify<T>(
    value: T,
    replacer?: (key: string, value: any) => any,
    space?: string | number
  ): string &amp; Stringified<T>
  parse<T>(text: Stringified<T>, reviver?: (key: any, value: any) => any): T
  parse(text: string, reviver?: (key: any, value: any) => any): any
}

export type MessageClusterRecord<Meta = any, TaskMeta = any> = {
  type: RecordType
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  status: Status
  error?: any[]
  statusCode: StatusCode
  startedAt: string
  completedAt: string | null
  completedTasks: Task<TaskMeta>[]
  incompleteTasks: Task<TaskMeta>[]
  bucketParams: {
    Bucket: string
    Key: string
  }
  meta?: Meta
  updatedAt: string
  expiresAt: string
}

export type MessageRecord<Meta = any, Body = any> = {
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  id: string
  url: string
  meta?: Meta
  body: String &amp; Stringified<Body>
  type: RecordType
  startedAt: string
  status: Status
  statusCode: StatusCode
  completedAt: string | null
  updatedAt: string
  expiresAt: string
  consumtion_count: number
  error?: any[]
}

export type Task<Meta = any> = {
  meta: Meta
  type: <SINGLE-QUOTE>task<SINGLE-QUOTE>
  id?: string
  status?: Status
}

export enum RecordType {
  cluster = <SINGLE-QUOTE>cluster<SINGLE-QUOTE>,
  task = <SINGLE-QUOTE>task<SINGLE-QUOTE>,
  message = <SINGLE-QUOTE>message<SINGLE-QUOTE>
}

export enum Status {
  preFlight = <SINGLE-QUOTE>PRE FLIGHT<SINGLE-QUOTE>,
  inProgress = <SINGLE-QUOTE>IN PROGRESS<SINGLE-QUOTE>,
  complete = <SINGLE-QUOTE>COMPLETE<SINGLE-QUOTE>,
  error = <SINGLE-QUOTE>ERROR<SINGLE-QUOTE>
}

export enum StatusCode {
  preFlight = 0,
  inProgress = 100,
  complete = 200,
  error = 400,
  stopped = 500
}

type Response<Meta = any, Globals = any, Body = any> = {
  url: string
  pKey: SQSMessageKey
  rKey: SQSMessageKey
  task?: string
  id?: string
  body: Body
  type: RecordType,
  getMessageCluster?: 
    (consistentRead?: boolean) => Promise<{ 
      record: MessageClusterRecord<Meta>,
      getGlobals: () => Promise<Globals> 
    }>,
  getMessageRecord: (consistentRead?: boolean) => Promise<MessageRecord<Meta>>
}

/**
 * Parse the SQS record to gain access to helpful meta data and getters
 * @param event - The SQS record to parse
 * @returns The basic meta data for the message and getters for globals and record
 */
function readSQSRecord<Body = any, Meta = any, Globals = any>(record: SQSRecord): Response<Meta, Globals, Body> {
  const body: any = JSON.parse(record.body)
  const url = <SINGLE-QUOTE>jfkdla;f<SINGLE-QUOTE>
  const pKey = `SQSMesssage${<SINGLE-QUOTE>fdfdafda<SINGLE-QUOTE>}` as SQSMessageKey
  const id = <SINGLE-QUOTE>jfkdlafjkdal;<SINGLE-QUOTE>
  const rKey = `SQSMesssage${<SINGLE-QUOTE>jfkdla;fjkda<SINGLE-QUOTE>}` as SQSMessageKey
  const task = undefined
  const type = RecordType.message || RecordType.cluster
  return {
    url,
    pKey,
    rKey,
    task,
    body,
    type,
    id: record.messageId,
    getMessageRecord: (consistentRead = false) =>
      (async <Meta>() => ({
        pKey,
        rKey,
        id,
        url,
        meta: body.meta,
        body: body.body,
        type,
        startedAt: body.startedAt,
        status: body.status,
        statusCode: body.statusCode,
        completedAt: body.completedAt,
        updatedAt: body.updatedAt,
        expiresAt: body.expiresAt,
        consumtion_count: body.consumtion_count,
        error: body.error
      }))(),
  }
}
export async function updateClusterGlobals<Globals = any>(
  key: { pKey: SQSMessageKey, rKey: SQSMessageKey }, 
  globals: Globals | ((globals: Globals) => Globals)
): Promise<{ pKey: string, rKey: string }> {
  return { pKey: <SINGLE-QUOTE><SINGLE-QUOTE>, rKey: <SINGLE-QUOTE><SINGLE-QUOTE> }
}

// ---cut---

type Body = {
  data: string,
  moreData: number
}

type MetaData = {
  stuff: string
}

type Globals = {
  firstName: string,
  lastName: string
}[]

async function processMessage(record: SQSRecord) {
  const { id, body, getMessageRecord, getMessageCluster } = 
    readSQSRecord<Body, MetaData, Globals>(record)
  
  const messageRecord = await getMessageRecord()

  // Perform a total rewrite of the global store
  await updateClusterGlobals<Globals>(
    { pKey: messageRecord.pKey, rKey: messageRecord.rKey },
    [{ firstName: <SINGLE-QUOTE>John<SINGLE-QUOTE>, lastName: <SINGLE-QUOTE>Doe<SINGLE-QUOTE> }]
  )

  // Perform a insert of data to the global store
  await updateClusterGlobals<Globals>(
    { pKey: messageRecord.pKey, rKey: messageRecord.rKey },
    (globals: Globals) => [...globals, { firstName: <SINGLE-QUOTE>John<SINGLE-QUOTE>, lastName: <SINGLE-QUOTE>Doe<SINGLE-QUOTE> }]
  )
}
" style="position:absolute;top:7.5px;right:6px;cursor:pointer;outline:none;" title="Copy"><span style="" class="heroicon heroicon-duplicate"></span></button><!--]-->
    
    <script>
      /* Check prefere color scheme **/
      (function() {
        // Current themes are 🐧, 🧛🏻‍♂️, 🐺
        document.documentElement.classList.add(
          localStorage.getItem('theme') || '🧛🏻‍♂️',
        ) // Default theme is dracula
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        const setting = localStorage.getItem('color-schema') || 'auto'
        if (setting === 'dark' || (prefersDark && setting !== 'light'))
          document.documentElement.classList.toggle('dark', true)
      })()
    </script>
  

<link rel="stylesheet" href="/assets/app.918e7b3f.css"></body></html>